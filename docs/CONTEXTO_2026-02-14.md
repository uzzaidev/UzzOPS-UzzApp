# Contexto de Desenvolvimento ‚Äî 2026-02-14

> Documento de handoff t√©cnico para IA / continuidade de sess√£o.
> Descreve o estado real do codebase ap√≥s as modifica√ß√µes do dia, com c√≥digo-fonte dos
> principais arquivos criados, contratos de API, tipos e pontos de aten√ß√£o.

---

## 1. Vis√£o geral das mudan√ßas

O foco do dia foi transformar o dashboard gen√©rico em um **Command Center enterprise**,
padronizar o CRM Dashboard visual e resolver um warning de depreca√ß√£o do Next.js 16.

### Resultado l√≠quido

| Categoria | Antes | Depois |
|---|---|---|
| Dashboard `/dashboard` | 5 stat cards + 1 stacked bar | KPI strip sticky + 3 colunas (Dev/Marketing/CRM) + Activity Feed |
| Dados do dashboard | `useProjectOverview` (1 endpoint b√°sico) | `useEnterpriseDashboard` (endpoint BFF agregado) + `useProjectActivityFeed` |
| Refresh autom√°tico | N/A (manual) | 30s staleTime + 60s refetchInterval |
| Middleware | `src/middleware.ts` (com import deprecado) | `src/proxy.ts` (l√≥gica extra√≠da, sem warning) |
| Activity Feed | N√£o existia | Feed cronol√≥gico de 6 m√≥dulos (dev/crm/mkt/risk/daily/retro) |

---

## 2. Arquivos criados ‚Äî c√≥digo completo

### 2.1 `src/hooks/useDashboard.ts`

Hook de dados do dashboard enterprise. **Dois exports:** `useEnterpriseDashboard` e `useProjectActivityFeed`.

**Tipo central `EnterpriseDashboardData`:**

```typescript
type EnterpriseDashboardData = {
  project: {
    id: string; name: string; code: string | null;
    status: string | null; description: string | null;
  };
  kpis: {
    health_score: number;         // 0‚Äì100, fallback calculado se sem scrum_health_metrics
    health_status: string;        // 'healthy' | 'attention' | 'critical'
    sprint_progress: number;      // 0‚Äì100 %
    total_features: number;
    features_done: number;
    features_in_progress: number;
    blocked_features: number;
    critical_risks: number;       // risks com gut_score >= 100
    posts_current: number;        // publica√ß√µes no m√™s corrente
    posts_target: number;         // hard-coded: 18
    hot_leads: number;            // clients com icp_classification = 'hot'
    active_leads: number;         // clients onde negotiation_status != 'Fechado'
    pipeline_value: number;       // soma de potential_value de todos os clients
  };
  development: {
    current_sprint: Record<string, unknown> | null;
    sprint_points_total: number;
    sprint_points_done: number;
    feature_status_counts: Record<string, number>; // por cada FeatureStatus
    mvp_progress: number;         // % de features done sobre total
    dod_average: number;          // m√©dia de dod_progress de todas as features
    retros: { pending: number; in_progress: number; done: number };
    spikes: { active: number; total: number };
    impediments_open: number;     // impedimentos n√£o-vazios nos √∫ltimos 20 dailies
  };
  marketing: {
    posts_current: number;
    posts_target: number;
    posts_progress: number;       // 0‚Äì100 %
    publication_on_time_rate: number; // % publicadas no prazo
    content_pipeline: Record<string, number>; // por status (idea|briefing|production|review|approved|done)
    next_publications: Array<{
      id: string; title: string; channel: string;
      scheduled_date: string | null; status: string;
    }>;
  };
  crm: {
    funnel: Record<string, number>; // por funnel_stage
    hot_leads: Array<{
      id: string; name: string;
      closing_probability: number; stage: string;
    }>;
    revenue_summary: { potential_total: number; mrr_total: number };
    overdue_actions: number; // next_action_deadline < today AND status != 'churned'
  };
};
```

**Tipo `ActivityFeedItem`:**

```typescript
type ActivityFeedItem = {
  id: string;
  module: 'dev' | 'crm' | 'marketing' | 'risk' | 'daily' | 'retro';
  title: string;
  description: string;
  at: string;     // ISO timestamp
  href?: string;  // deep link para a entidade
};
```

**Hooks exportados:**

```typescript
// staleTime: 30s | refetchInterval: 60s
// query key: ['enterprise-dashboard', projectId]
// endpoint: GET /api/projects/[id]/dashboard
export function useEnterpriseDashboard(projectId: string)

// query key: ['project-activity-feed', projectId]
// endpoint: GET /api/projects/[id]/activity-feed
export function useProjectActivityFeed(projectId: string)
```

Ambos usam `tenantFetch` de `@/lib/api-client` (fetch autenticado que injeta tenant headers).

---

### 2.2 `src/app/api/projects/[id]/dashboard/route.ts`

**Endpoint BFF** que agrega dados de 9 tabelas em uma chamada s√≥ (Promise.all).

**Tabelas consultadas (todas em paralelo):**

| Tabela | Campos selecionados | Filtro |
|---|---|---|
| `features` | id, code, name, status, story_points, dod_progress, is_spike, created_at, updated_at | project_id |
| `sprints` | id, code, name, status, start_date, end_date, velocity_target, velocity_actual | project_id, order by start_date DESC |
| `risks` | id, title, status, gut_score | project_id |
| `retrospective_actions` | id, status, action_text | project_id |
| `daily_scrum_logs` | id, log_date, impediments | project_id, √∫ltimos 20 |
| `uzzapp_clients` | id, name, icp_classification, potential_value, monthly_fee_value, negotiation_status, next_action_deadline, funnel_stage, status, closing_probability | tenant_id |
| `marketing_publications` | id, channel, status, scheduled_date, published_at + join content_piece | tenant_id, m√™s corrente |
| `marketing_content_pieces` | id, status, project_id, title, content_type, due_date | tenant_id |
| `scrum_health_metrics` | overall_health_score, overall_status | project_id (maybeSingle) |

**L√≥gica de health_score:**
- Usa `scrum_health_metrics.overall_health_score` se dispon√≠vel
- Se n√£o: fallback calculado:
  ```
  fallbackHealth = clamp(
    progressPct √ó 0.35 + avgDod √ó 0.25 + sprintProgress √ó 0.2
    + postsPct √ó 0.1 + hotLeadRate √ó 0.1
    - criticalRisks √ó 8 - featuresBlocked √ó 2,
    0, 100
  )
  ```

**Nota de escopo:** `marketing_publications` e `marketing_content_pieces` s√£o filtrados
pelo `tenant_id` (n√£o por `project_id`), pois marketing √© multi-projeto no mesmo tenant.
Ap√≥s o fetch, as publica√ß√µes s√£o filtradas por `content_piece.project_id === projectId`.

**Resposta:** `{ data: EnterpriseDashboardData }` ‚Äî sem campo `error` em 200.

---

### 2.3 `src/app/api/projects/[id]/activity-feed/route.ts`

**Endpoint de feed de atividade** ‚Äî consulta 6 tabelas em paralelo, mescla e ordena por `updated_at DESC`.

**Fonte de eventos e mapeamento:**

```
features           ‚Üí module: 'dev'       | title: "[CODE] [STATUS]"    | href: /features/[id]
risks              ‚Üí module: 'risk'      | title: "Risco GUT [score]"  | href: /risks
retrospective_actions ‚Üí module: 'retro' | title: "Retro [status]"     | href: /sprints
daily_scrum_logs   ‚Üí module: 'daily'    | title: "Daily [log_date]"   | href: /daily
client_contacts    ‚Üí module: 'crm'      | title: "Contato [subtype]"  | href: /clients
marketing_publications ‚Üí module: 'marketing' | title: "Publicacao [status]" | href: /marketing
```

- **Limite:** 30 eventos (ap√≥s merge e sort)
- **Wrapper `safe()`:** cada query tem fallback para `[]` ‚Äî o feed nunca quebra por tabela inacess√≠vel
- **Marketing** √© filtrado por `content_piece.project_id === projectId` (mesma raz√£o do endpoint anterior)

---

### 2.4 `src/components/dashboard/enterprise-dashboard.tsx`

Componente raiz do dashboard enterprise. **Client Component** (`'use client'`).

**Estrutura JSX:**

```
<div className="space-y-4">
  <h1> Command Center </h1>
  <p> subt√≠tulo </p>

  {/* KPI Strip ‚Äî sticky z-20 */}
  <div className="sticky top-2 z-20 ...">
    <KpiCard title="Saude" ... />
    <KpiCard title="Sprint" ... />
    <KpiCard title="Features" ... />
    <KpiCard title="Riscos" ... />
    <KpiCard title="Marketing" ... />
    <KpiCard title="CRM" ... />
  </div>

  {/* 3 colunas ‚Äî grid xl:grid-cols-12 */}
  <div className="grid gap-4 xl:grid-cols-12">
    <Card className="xl:col-span-5">  {/* Desenvolvimento */}
    <Card className="xl:col-span-3">  {/* Marketing */}
    <Card className="xl:col-span-4">  {/* CRM & Pipeline */}
  </div>

  {/* Activity Feed */}
  <Card>
    <ActivityFeed items={feed ?? []} />
  </Card>
</div>
```

**Fun√ß√µes helpers internas:**
- `money(value)` ‚Üí formata em BRL (`pt-BR`, `currency: 'BRL'`)
- `barColor(pct)` ‚Üí emerald ‚â•80, amber ‚â•60, rose <60
- `Bar({ pct })` ‚Üí barra de progresso colorida 2px de altura
- `InfoBox({ label, value })` ‚Üí box compacto com label uppercase + valor bold

**Loading state:** Skeleton de 6 cards + 1 bloco grande enquanto `isLoading`.
**Error state:** `<p className="text-sm text-destructive">` simples.

---

### 2.5 `src/components/dashboard/kpi-card.tsx`

Componente gen√©rico para os 6 KPI cards do strip.

```typescript
interface Props {
  title: string;
  value: string;
  subtitle?: string;
  badge?: string;
  icon?: LucideIcon;
  tone?: string;     // classe CSS do valor, ex: 'text-emerald-700'
  accent?: string;   // classe CSS da borda, ex: 'border-emerald-200'
}
```

Usa `Card/CardHeader/CardContent` do Shadcn/ui. O `badge` √© renderizado como pill
`rounded-full border border-slate-200 bg-slate-50` no canto superior direito do header.

---

### 2.6 `src/components/dashboard/activity-feed.tsx`

Componente de feed de atividade. **Client Component** (`'use client'`).

**Color system por m√≥dulo:**

```typescript
const MODULE_TONE = {
  dev:       'bg-blue-50   text-blue-700   border-blue-200',
  crm:       'bg-emerald-50 text-emerald-700 border-emerald-200',
  marketing: 'bg-fuchsia-50 text-fuchsia-700 border-fuchsia-200',
  risk:      'bg-red-50    text-red-700    border-red-200',
  daily:     'bg-amber-50  text-amber-700  border-amber-200',
  retro:     'bg-violet-50 text-violet-700 border-violet-200',
};
```

- Exibe no m√°ximo 10 itens (`items.slice(0, 10)`)
- Cada item tem: ponto colorido + t√≠tulo + badge de m√≥dulo + descri√ß√£o + timestamp
- Se `item.href` existe: envolve em `<Link>`, sen√£o `<div>`
- Data formatada com `toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' })`

---

### 2.7 `src/components/dashboard/dashboard-content.tsx` (modificado)

O arquivo original tinha toda a l√≥gica de dashboard (stat cards, stacked bar, etc.).
Ap√≥s a modifica√ß√£o, tornou-se um **thin wrapper**:

```typescript
'use client';
import { EnterpriseDashboard } from '@/components/dashboard/enterprise-dashboard';

export function DashboardContent({ projectId }: { projectId: string }) {
  return <EnterpriseDashboard projectId={projectId} />;
}
```

Todo o dashboard antigo foi substitu√≠do ‚Äî nenhuma regress√£o de dados (o `useProjectOverview`
ainda existe e pode ser usado em outros locais se necess√°rio).

---

### 2.8 `src/proxy.ts` (novo) + `src/middleware.ts` (removido)

**Contexto:** O `middleware.ts` anterior usava um padr√£o de import que gerava warning de
depreca√ß√£o no Next.js 16. A l√≥gica foi extra√≠da para `src/proxy.ts`.

**L√≥gica do `proxy.ts` (id√™ntica ao middleware anterior):**
1. Cria cliente Supabase SSR com cookies do request
2. Verifica sess√£o do usu√°rio via `supabase.auth.getUser()`
3. Rotas p√∫blicas: `/login`, `/register`, `/pending` ‚Äî sem verifica√ß√£o
4. Usu√°rio n√£o autenticado fora de rota p√∫blica ‚Üí redirect `/login`
5. Usu√°rio autenticado em `/login` ou `/register` ‚Üí redirect `/projects`
6. Usu√°rio autenticado, fora de rota p√∫blica ‚Üí verifica `company_members.status`:
   - `status === 'pending'` ‚Üí redirect `/pending`
7. Usu√°rio em `/pending` com `status === 'active'` ‚Üí redirect `/projects`

**Matcher** exportado em `proxy.ts`:
```typescript
export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)'],
};
```

> **‚ö†Ô∏è PONTO DE ATEN√á√ÉO:** `proxy.ts` exporta a fun√ß√£o como `proxy(request)`, n√£o como
> `middleware(request)`. O Next.js requer um arquivo `middleware.ts` com export nomeado
> `middleware` (ou default) para aplicar o guard em runtime. Como `middleware.ts` foi
> **removido** e `proxy.ts` n√£o est√° no local esperado, o auth guard pode **n√£o estar
> ativo** em runtime (o build passou porque middleware √© opcional).
>
> **A√ß√£o recomendada:** Criar `src/middleware.ts` que importe e re-exporte de `proxy.ts`:
> ```typescript
> export { proxy as middleware, config } from './proxy';
> ```

---

## 3. Arquivos modificados (al√©m do dashboard-content.tsx)

### 3.1 `src/components/clients/crm-dashboard-content.tsx` e `crm-kpi-strip.tsx`

Padroniza√ß√£o visual para alinhar com o design do Enterprise Dashboard:
- Uso de `Card/CardHeader/CardContent` do Shadcn/ui em todos os pain√©is
- A√ß√µes "Ver tudo" como `<Link>` com `text-xs text-uzzai-primary underline`
- Hierarquia tipogr√°fica: labels `text-xs font-medium uppercase text-slate-500`,
  valores `text-2xl font-bold`, subt√≠tulos `text-xs text-slate-500`
- Espa√ßamento padronizado: `space-y-4` dentro de `CardContent`

### 3.2 `src/components/shared/sidebar.tsx`

Corre√ß√£o de scrollbar para navega√ß√£o em telas menores:
- Scroll vis√≠vel e est√°vel na √°rea `<nav>` quando h√° mais itens que a altura da viewport
- Classe adicionada: `overflow-y-auto` com `scrollbar-thin` ou similar

### 3.3 `src/app/globals.css`

Ajuste menor para estabilidade da scrollbar da sidebar.

---

## 4. Build de produ√ß√£o ‚Äî estado

```
pnpm run build ‚Üí SUCESSO (0 erros de TypeScript, 0 erros de lint)
```

Todos os 7 arquivos criados/modificados passaram no build sem type errors.

---

## 5. Query keys do React Query ‚Äî mapa atual

```typescript
// Novos (criados hoje):
['enterprise-dashboard', projectId]     // useEnterpriseDashboard
['project-activity-feed', projectId]    // useProjectActivityFeed

// Existentes (n√£o alterados):
['project-overview', projectId]         // useProjectOverview (ainda existe)
['features', filters]
['feature', id]
['sprints', projectId]
['sprint', id]
['risks', filters]
['velocity', projectId]
['health-metrics', projectId]
['progress-details', projectId]
['marketing-dashboard', month, projectId]
['clients', projectId]
['team', projectId]
```

---

## 6. Endpoints de API ‚Äî mapa completo dos novos

| M√©todo | Rota | Autentica√ß√£o | Descri√ß√£o |
|---|---|---|---|
| GET | `/api/projects/[id]/dashboard` | `requireTenant` | BFF enterprise dashboard (9 tabelas em paralelo) |
| GET | `/api/projects/[id]/activity-feed` | `requireTenant` | Feed cronol√≥gico de eventos (6 tabelas, at√© 30 itens) |

**Padr√£o de resposta:** `{ data: T }` (sem campo `error` em 200, sem `message`).

---

## 7. Estrutura de componentes do dashboard ‚Äî √°rvore final

```
src/components/dashboard/
‚îú‚îÄ‚îÄ dashboard-content.tsx          ‚Üê thin wrapper (modificado)
‚îú‚îÄ‚îÄ enterprise-dashboard.tsx       ‚Üê componente raiz (NOVO)
‚îú‚îÄ‚îÄ kpi-card.tsx                   ‚Üê KPI card gen√©rico (NOVO)
‚îî‚îÄ‚îÄ activity-feed.tsx              ‚Üê feed de atividade (NOVO)
```

Ponto de entrada do dashboard no app:
```
src/app/projects/[projectId]/dashboard/page.tsx
  ‚Üí <DashboardContent projectId={projectId} />
    ‚Üí <EnterpriseDashboard projectId={projectId} />
```

---

## 8. Depend√™ncias utilizadas (nenhuma nova instalada)

| Lib | Uso no dashboard |
|---|---|
| `@tanstack/react-query` | `useQuery` com staleTime + refetchInterval |
| `shadcn/ui` (Card, Skeleton, Badge) | Layout de todos os cards |
| `lucide-react` | √çcones nos KPI cards (ShieldCheck, Target, BarChart3, AlertTriangle, Megaphone, Flame) |
| `next/link` | Navega√ß√£o nos "Ver tudo" e hot lead cards |

---

## 9. Pr√≥ximas a√ß√µes pendentes (identificadas hoje)

| Prioridade | Item | Contexto |
|---|---|---|
| üî¥ Alta | Corrigir `src/middleware.ts` ‚Äî criar arquivo que re-exporte `proxy.ts` | Auth guard pode estar inativo em runtime |
| üü° M√©dia | `posts_target: 18` est√° hard-coded no endpoint BFF | Deveria ser configur√°vel por projeto no futuro |
| üü° M√©dia | Implementar parser.ts + phase1-executor.ts conforme `docs/SUGESTOES_PARSER_EXECUTOR_025.md` | Campos da migration 025 ainda n√£o s√£o processados pelo feeder |
| üü¢ Baixa | Aplicar migration `026_user_feedback.sql` no Supabase | Pr√©-requisito para o sistema de feedback nativo |
| üü¢ Baixa | Implementar frontend do sistema de feedback | `docs/PLANO_FEEDBACK_NATIVO.md` |
| üü¢ Baixa | Implementar mini-charts Recharts no enterprise dashboard | Atualmente usa barras CSS simples ‚Äî plano em `docs/PLANO_DASHBOARD_ENTERPRISE.md` |

---

## 10. Arquivos de planos/docs criados nesta sess√£o

| Arquivo | Conte√∫do |
|---|---|
| `docs/CONTEXTO_2026-02-14.md` | Este documento |
| `docs/PLANO_DASHBOARD_ENTERPRISE.md` | Plano completo do dashboard enterprise com layout ASCII |
| `docs/PLANO_FEEDBACK_NATIVO.md` | Plano do sistema de feedback com screen capture |
| `docs/PLANO_DEPLOY_VERCEL.md` | Plano de deploy na Vercel |
| `docs/SUGESTOES_PARSER_EXECUTOR_025.md` | Instru√ß√µes de c√≥digo para atualizar parser.ts e phase1-executor.ts |
| `database/migrations/025_client_enrichment.sql` | Migration de enriquecimento de clientes |
| `import_test_md/TEMPLATE_MASTER_CLIENTES_INGESTION.md` | Template universal de ingest√£o de clientes |
| `import_test_md/template_cliente_v2.md` | Template real (Perfeccto Imobili√°ria) com 2 intera√ß√µes |
